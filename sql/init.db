-- Path: sql/SCHEMA.sql
CREATE TABLE IF NOT EXISTS "user" (
    id SERIAL PRIMARY KEY,
    username TEXT NOT NULL,
    email TEXT NOT NULL,
    password TEXT NOT NULL,
    creation_date TIMESTAMP NOT NULL
);

CREATE TABLE IF NOT EXISTS follow (
    id SERIAL PRIMARY KEY,
    follower SERIAL NOT NULL,
    followed SERIAL NOT NULL,
    creation_date TIMESTAMP NOT NULL,
    UNIQUE(follower, followed),
    FOREIGN KEY (follower) REFERENCES "user"(id),
    FOREIGN KEY (followed) REFERENCES "user"(id)
);

CREATE TABLE IF NOT EXISTS post (
    id SERIAL PRIMARY KEY,
    "user" SERIAL NOT NULL,
    content TEXT NOT NULL,
    creation_date TIMESTAMP NOT NULL,
    FOREIGN KEY ("user") REFERENCES "user"(id)
);

DO $$ BEGIN
    CREATE TYPE reaction_type AS ENUM ('LIKE', 'DISLIKE');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

CREATE TABLE IF NOT EXISTS reaction (
    id SERIAL PRIMARY KEY,
    "user" SERIAL NOT NULL,
    post SERIAL NOT NULL,
    reaction reaction_type NOT NULL,
    creation_date TIMESTAMP NOT NULL,
    FOREIGN KEY ("user") REFERENCES "user"(id),
    FOREIGN KEY (post) REFERENCES post(id)
);

CREATE TABLE IF NOT EXISTS product (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    barcode TEXT NOT NULL,
    price REAL NOT NULL DEFAULT 0.0
);

CREATE TABLE IF NOT EXISTS address (
    id SERIAL PRIMARY KEY,
    street TEXT NOT NULL,
    city TEXT NOT NULL,
    postal_code VARCHAR(5) NOT NULL
);

CREATE TABLE IF NOT EXISTS billing_address (
    id SERIAL PRIMARY KEY,
    "user" SERIAL NOT NULL,
    address SERIAL NOT NULL,
    FOREIGN KEY ("user") REFERENCES "user"(id),
    FOREIGN KEY (address) REFERENCES address(id)
);

CREATE TABLE IF NOT EXISTS "order" (
    id SERIAL PRIMARY KEY,
    "user" SERIAL NOT NULL,
    shipping_address SERIAL NOT NULL,
    creation_date TIMESTAMP NOT NULL,
    FOREIGN KEY ("user") REFERENCES "user"(id),
    FOREIGN KEY (shipping_address) REFERENCES address(id)
);

CREATE TABLE IF NOT EXISTS order_item (
    id SERIAL PRIMARY KEY,
    "order" SERIAL NOT NULL,
    product SERIAL NOT NULL,
    price REAL NOT NULL DEFAULT 0.0,
    FOREIGN KEY ("order") REFERENCES "order"(id),
    FOREIGN KEY (product) REFERENCES product(id)
);

