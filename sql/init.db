-- Path: sql/SCHEMA.sql
CREATE TABLE IF NOT EXISTS "user" (
    id SERIAL PRIMARY KEY,
    email TEXT NOT NULL,
    username TEXT NOT NULL,
    password TEXT NOT NULL,
    creation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS follow (
    id SERIAL PRIMARY KEY,
    follower INT NOT NULL,
    followed INT NOT NULL,
    creation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(follower, followed),
    FOREIGN KEY (follower) REFERENCES "user"(id),
    FOREIGN KEY (followed) REFERENCES "user"(id)
);

CREATE TABLE IF NOT EXISTS product (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    barcode TEXT NOT NULL,
    price REAL NOT NULL
);

CREATE TABLE IF NOT EXISTS post (
    id SERIAL PRIMARY KEY,
    author INT NOT NULL,
    content TEXT NOT NULL,
    product INT,
    creation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (author) REFERENCES "user"(id),
    FOREIGN KEY (product) REFERENCES product(id)
);

DO $$ BEGIN
    CREATE TYPE reaction_type AS ENUM ('LIKE', 'DISLIKE');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

CREATE TABLE IF NOT EXISTS reaction (
    id SERIAL PRIMARY KEY,
    "user" INT NOT NULL,
    post INT NOT NULL,
    reaction reaction_type NOT NULL,
    creation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY ("user") REFERENCES "user"(id),
    FOREIGN KEY (post) REFERENCES post(id)
);

CREATE TABLE IF NOT EXISTS address (
    id SERIAL PRIMARY KEY,
    street TEXT NOT NULL,
    city TEXT NOT NULL,
    postal_code VARCHAR(5) NOT NULL
);

CREATE TABLE IF NOT EXISTS "order" (
    id SERIAL PRIMARY KEY,
    "user" INT NOT NULL,
    billing_address INT NOT NULL,
    shipping_address INT NOT NULL,
    product INT NOT NULL,
    price REAL NOT NULL,
    creation_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY ("user") REFERENCES "user"(id),
    FOREIGN KEY (billing_address) REFERENCES address(id),
    FOREIGN KEY (product) REFERENCES product(id),
    FOREIGN KEY (shipping_address) REFERENCES address(id)
);
